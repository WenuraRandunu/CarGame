<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Responsive Car Game (with Quiz)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #111;
      font-family: sans-serif;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      overflow: hidden;
    }

    button { padding: 5px 10px; margin: 3px; font-size: 15px; cursor: pointer; }

    #container { display: flex; flex-direction: column; align-items: center; width: 100%; height: 85vh; }

    #infoBar { display: none; justify-content: space-around; width: 100%; max-width: 400px; margin-bottom: 5px; font-size: 14px; }
    #gameCanvas { display: none; width: 88vw; max-width: 308px; height: auto; aspect-ratio: 3 / 5; background: #333; border: 2px solid white; touch-action: manipulation; }

    #popup { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 999; }
    #popupContent { background: #222; padding: 20px; border-radius: 10px; text-align: center; color: #fff; }

    #userForm { background: #000; display: flex; flex-direction: column; align-items: center; transform: scale(1.0); transform-origin: top center; margin-top: 20px; padding: 20px; border-radius: 10px; }
    #userForm input { padding: 10px; font-size: 16px; width: 250px; margin: 5px 0; background-color: lightblue; color: black; border-radius: 8px; border: none; }

    #quizModal {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 1000;
      background: rgba(0,0,0,0.85);
    }
    #quizBox {
      width: 92%;
      max-width: 460px;
      background: #10CFE8;
      border-radius: 12px;
      padding: 20px;
      text-align: left;
      color: black;
      box-shadow: 0 8px 30px rgba(0,0,0,0.7);
    }
    #quizQuestion { font-size: 18px; margin-bottom: 12px; color: #000000;}
    .choiceBtn {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      border-radius: 8px;
      background: #2b2b2f;
      color: #fff;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 16px;
    }
    .choiceBtn:hover { filter: brightness(1.08); }
    #quizHeader { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    #quizTimerNote { font-size: 13px; opacity: 0.8; }
    #topRightLogo { position: absolute; top: 10px; right: 10px; width: 80px; height: auto; }
    #formLogo { width: 100%; max-width: 200px; margin-bottom: 20px; }
    #formTitle { font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 8px; text-align: center; }
  </style>
</head>
<body>
  <img src="https://raw.githubusercontent.com/WenuraRandunu/CarGame/main/assets/aps.png" id="topRightLogo" alt="Logo" />
  <div id="userForm">
    <div id="formTitle">FORMULA 1 ATL GRAND PRIX</div>
    <img src="https://raw.githubusercontent.com/WenuraRandunu/CarGame/main/assets/cps.png" id="formLogo" alt="Logo 2" />
    <input type="text" id="empNo" placeholder="Employee Number" required maxlength="5" pattern="\d{5}" inputmode="numeric" />
    <!-- <input type="text" id="dept" placeholder="Department" required maxlength="30" pattern="[A-Za-z\s]+" inputmode="text" /> -->
    <select id="dept" required style="padding: 10px; font-size: 16px; width: 250px; margin: 5px 0; background-color: lightblue; color: black; border-radius: 8px; border: none;">
      <option value="" disabled selected>Select Department</option>
      <option value="BP">BP</option>
      <option value="Cutting">Cutting</option>
      <option value="Cut & Sewing">Cut & Sewing</option>
      <option value="EHS">EHS</option>
      <option value="Engineering">Engineering</option>
      <option value="Fabric Coating">Fabric Coating</option>
      <option value="Fabric Finishing">Fabric Finishing</option>
      <option value="Fabric Knitting">Fabric Knitting</option>
      <option value="Finance">Finance</option>
      <option value="Glove Knitting">Glove Knitting</option>
      <option value="Human Resources">Human Resources</option>
      <option value="IT">IT</option>
      <option value="Lab">Lab</option>
      <option value="Liner Ware House">Liner Ware House</option>
      <option value="Planing">Planing</option>
      <option value="Printing">Printing</option>
      <option value="Quality Assurance">Quality Assurance</option>
      <option value="R & D">R & D</option>
      <option value="R-840">R-840</option>
      <option value="Stores">Stores</option>
      <option value="Transport">Transport</option>
      <option value="TPR">TPR</option>
      <option value="Washing">Washing</option>
      <option value="Yarn Covering">Yarn Covering</option>
      <option value="Other">Other</option>
    </select>
    <button onclick="submitUserInfo()" style="background-color: #5e56dc; color: white; border: none; border-radius: 10px; cursor: pointer;">Play Game</button>
  </div>

  <div id="controls" style="display:none;">
    <button id="startBtn" style="background-color: #27e830; color: #09090a; border: none; border-radius: 10px; cursor: pointer;">Start Game</button>
    <button onclick="closeGame()" style="background-color: #f14e2a; color: #09090a; border: none; border-radius: 10px; cursor: pointer;">Close Game</button>
  </div>

  <div id="infoBar">
    <div id="lives">Lives: 3</div>
    <div id="score">Score: 0</div>
    <div id="timer">Time: 60s</div>
  </div>

  <canvas id="gameCanvas" width="330" height="550"></canvas>

  <div id="popup">
    <div id="popupContent">
      <h2>Game Over!</h2>
      <p id="finalScore">Score: 0</p>
      <button onclick="closePopup()" style="background-color: #f14e2a; color: #09090a; border: none; border-radius: 10px; cursor: pointer;">Close</button>
    </div>
  </div>

  <!-- Quiz Modal -->
  <div id="quizModal">
    <div id="quizBox">
      <div id="quizHeader">
        <div id="quizTitle">Pop Quiz</div>
        <div id="quizTimerNote">Answer time doesn't reduce game time</div>
      </div>
      <div id="quizQuestion"></div>
      <div id="quizChoices"></div>
    </div>
  </div>

  <!-- Audio -->
  <audio id="bgMusic" loop>
    <source src="https://raw.githubusercontent.com/WenuraRandunu/CarGame/main/assets/bg.mp3" type="audio/mpeg">
  </audio>
  <audio id="blockSound">
    <source src="https://raw.githubusercontent.com/WenuraRandunu/CarGame/main/assets/block.mp3" type="audio/mpeg">
  </audio>
  <audio id="asdSound">
    <source src="https://raw.githubusercontent.com/WenuraRandunu/CarGame/main/assets/asd.mp3" type="audio/mpeg">
  </audio>

  <script>
    // ---- User input sanitizers ----
    document.getElementById("dept").addEventListener("input", function () {
      this.value = this.value.replace(/[^a-zA-Z\s]/g, "").slice(0, 30);
    });
    document.getElementById("empNo").addEventListener("input", function () {
      this.value = this.value.replace(/[^0-9]/g, "").slice(0, 5);
    });

    // ---- Canvas & game variables ----
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const lanes = [35, 135, 235];
    const githubBase = "https://raw.githubusercontent.com/WenuraRandunu/CarGame/main/assets";
    const player = { lane: 1, y: 440, width: 66, height: 79 };
    let score = 0, lives = 3, timeLeft = 60;
    let gameRunning = false;     // true when game active (not game over)
    let quizActive = false;      // true while quiz modal open (pauses gameplay)
    let magnetActive = false, magnetTimer = 0;
    let speed = 2.2;
    const items = [];
    let spawnInterval = null;
    let playTickInterval = null; // increments active-play seconds and decrements timeLeft
    let userData = {}, userSubmitted = false;
    let playSecondsElapsed = 0; // counts active gameplay seconds (does not include quiz time)
    let nextQuizAt = 15;        // show first quiz when playSecondsElapsed >= 15, then +=15

    // images
    const carImage = new Image(); carImage.src = githubBase + "/car.png";
    const icons = [
      { type: "group", img: githubBase + "/group.png" },
      { type: "safety", img: githubBase + "/safety.png" },
      { type: "sustainability", img: githubBase + "/sustainability.png" },
    ];
    const iconImages = {};
    icons.forEach(icon => { const img = new Image(); img.src = icon.img; iconImages[icon.type] = img; });

    const pointWords = ["DDS", "Center\nlines", "Defect\nHandling", "IPS", "UPS", "Kaizen", "5S"];
    const wordBlocks = ["Absenteeism", "Reject", "Rework", "Break\ndown", "Powercut", "Cut\npart\ndelay", "System\ndown", "Forklift\ndelay", "Scraps", "Size\nchanges", "Style\nchanges"];

    // ---- Simple question bank (multiple choice). Edit/add here ----
    // Each question: { q: "question text", choices: ["A","B","C","D"], answerIndex: 0 }
    const questions = [
    {
      q: "මැෂින් මත අනවශ්‍ය දේවල් තබා ඇත්නම් එය කුමන දෝෂ වර්ගයකට අයත්ද?",
      choices: [
        "Unnecessary items/Parts (අනවශ්‍ය සහ හදිසි නොවන අයිතම)",
        "Lack of Basic Condition ( ඉටු නොකළ මූලික අඩුපාඩු )",
        "Unsafe Conditions (අනාරක්ෂිත තත්ව)",
        "Sources of Contamination (අපිරිසිදු කාරක ප්‍රභව)"
      ],
      answerIndex: 0
    },
    {
      q: "මැෂින් කොටස්  පිරිසිදු කිරීමට අමාරු නම් එය කුමන දෝෂ වර්ගයකට අයත්ද?",
      choices: [
        "Minor Defects (සුළු අඩුපාඩු)",
        "Hard to Reach Area (ළඟා වීමට අපහසු ස්ථාන)",
        "Sources of Contamination (අපිරිසිදු කාරක ප්‍රභව)",
        "Unsafe Conditions (අනාරක්ෂිත තත්ව)"
      ],
      answerIndex: 1
    },
    {
      q: "මැෂින්වල වායු පීඩන මැනුම් උපකරණ බිඳී ඇත්නම් එය කුමන දෝෂ වර්ගයකට අයත්ද?",
      choices: [
        "Lack of Basic Condition ( ඉටු නොකළ මූලික අඩුපාඩු )",
        "Minor Defects (සුළු අඩුපාඩු)",
        "Quality Defect Sources (තත්ව අසාමාන්‍යතා ප්‍රභව)",
        "Unsafe Conditions (අනාරක්ෂිත තත්ව)"
      ],
      answerIndex: 0
    },
    {
      q: "බිම තෙතවී තිබේ, සේවකයා වැඩ කරන්නේ නම් එය කුමන දෝෂ වර්ගයකට අයත්ද?",
      choices: [
        "Unsafe Conditions (අනාරක්ෂිත තත්ව)",
        "Minor Defects (සුළු අඩුපාඩු)",
        "Lack of Basic Condition ( ඉටු නොකළ මූලික අඩුපාඩු )",
        "Quality Defect Sources (තත්ව අසාමාන්‍යතා ප්‍රභව)"
      ],
      answerIndex: 0
    },
    {
      q: "මැෂින් මත තෙල් පැල්ලම් හෝ දූවිලි තිබේ නම් එය කුමන දෝෂ වර්ගයකට අයත්ද?",
      choices: [
        "Minor Defects (සුළු අඩුපාඩු)",
        "Hard to Reach Area (ළඟා වීමට අපහසු ස්ථාන)",
        "Sources of Contamination (අපිරිසිදු කාරක ප්‍රභව)",
        "Unsafe Conditions (අනාරක්ෂිත තත්ව)"
      ],
      answerIndex: 2
    },
    {
      q: "සේවකයා ආරක්ෂා උපකරණ නොපැළඳීම කුමන දෝෂ වර්ගයකට අයත්ද?",
      choices: [
        "Unsafe Act (අනාරක්ෂිත ක්‍රියාව)",
        "Minor Defects (සුළු අඩුපාඩු)",
        "Quality Defect Sources (තත්ව අසාමාන්‍යතා ප්‍රභව)",
        "Lack of Basic Condition ( ඉටු නොකළ මූලික අඩුපාඩු )"
      ],
      answerIndex: 0
    },
    {
      q: "APS මාසික ඇගයීම් වලදී (R&R - Reward and Recognition) වලදී සලකා බලන්නේ?",
      choices: [
        "දෝෂ වැඩිපුර වාර්තා කිරීම",
        "වැඩිපුර IPS/UPS  කිරීම",
        "නව Centerlines හඳුන්වා දීම",
        "ඉහත සියල්ලම"
      ],
      answerIndex: 3
    },
    {
      q: "APS හි (ඇන්සෙල් නිෂ්පාදන ක්‍රමවේදයේ) ප්‍රධාන ඉලක්කය කුමක්ද?",
      choices: [
        "100% උපකරණ කාර්යක්ෂමතාව",
        "නාස්තීන් අඩු කිරීම",
        "100%ක් සේවක සහභාගිත්වය තුළින් සියලුම නාස්තීන් ශුන්‍ය කිරීම",
        "වාර්ෂික ආදායම දෙගුණ කිරීම"
      ],
      answerIndex: 2
    },
    {
      q: "APS ක්‍රමවේදය සඳහා 100% සහභාගීත්වය අවශ්‍ය වන්නේ කාගේද?",
      choices: [
        "කළමනාකාරීත්වයේ",
        "ඉංජිනේරු දෙපාර්තමේන්තුවේ",
        "සියලුම සේවකයන්ගේ",
        "සැපයුම්කරුවන්ගේ"
      ],
      answerIndex: 2
    },
    {
      q: "APS නිර්මාණය වීම සඳහා පදනම් කරගත් ප්‍රධාන කළමනාකරණ පද්ධති දෙක කුමක්ද?",
      choices: [
        "ISO සහ Kaizen",
        "JIT සහ TQM",
        "Lean Six Sigma සහ IWS",
        "MRP II සහ Kanban"
      ],
      answerIndex: 2
    },
    {
      q: "\"Power of 0 & 100\" යන්නෙන් අදහස් වන්නේ කුමක්ද?",
      choices: [
        "යන්ත්‍රයක වේගය 0 සිට 100 දක්වා වැඩි කිරීම",
        "100% සේවක සහභාගිත්වය තුළින් සියලුම නාස්තීන් ශුන්‍ය කර ගැනීම",
        "බිඳවැටීම් 0ක් සහ පැය 100ක වැඩමුරයක්",
        "තත්ත්ව ප්‍රමිතිය 100%ක පවත්වා ගැනීම"
      ],
      answerIndex: 1
    },
    {
      q: "APS තුළ Standard Work වැදගත් වන්නේ ඇයි?",
      choices: [
        "සේවකයින්ට ඕනෑම වෙලාවක ඔවුන්ගේ වැඩ කිරීමේ ක්‍රමය වෙනස් කිරීමට හැකිවීම",
        "සෑම විටම එකම ආකාරයකට, දෝෂ රහිතව සහ ඉහළ ගුණාත්මක බවකින් යුත් නිෂ්පාදන ලබාදීමට හැකිවීම",
        "සෑම සේවකයෙකුටම වේගයෙන් වැඩ කිරීමට හැකිවීම",
        "වැඩබිමේ ඇති සියලුම අනවශ්‍ය මෙවලම් ඉවත් කිරීමට හැකිවීම"
      ],
      answerIndex: 1
    },
    {
      q: "APS හි දවසේ දිශානතිය තීරණය කරන meeting එකේ නම කුමක්ද?",
      choices: [
        "DDS",
        "SDS",
        "MDS",
        "WDS"
      ],
      answerIndex: 0
    },
    {
      q: "DDS meeting එකේදී අවදානය යොමු කරන මූලික දේවල් මොනවාද?",
      choices: [
        "Defect Handling",
        "Safety Trigger & Quality Trigger",
        "Centerlines",
        "ඉහත සියල්ලම"
      ],
      answerIndex: 3
    },
    {
      q: "ගැටළු ඉක්මනින් මතු කිරීමට සහ විසඳීමට උපකාරී වන දෛනික ව්‍යුහගත ක්‍රියාවලිය කුමක්ද?",
      choices: [
        "AM",
        "BDE",
        "DDS",
        "CO"
      ],
      answerIndex: 2
    }
  ];

    // ---- Shuffle Questions (Fisher–Yates algorithm) ----
    function shuffleQuestions() {
      for (let i = questions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [questions[i], questions[j]] = [questions[j], questions[i]];
      }
    }
    shuffleQuestions();
    
    // ---- Reset & reshuffle automatically when all used ----
    let currentQuestionIndex = 0;
    function getNextQuestion() {
      if (currentQuestionIndex >= questions.length) {
        shuffleQuestions();
        currentQuestionIndex = 0;
      }
      return questions[currentQuestionIndex++];
    }


    // ---- UI update helpers ----
    function updateInfo() {
      document.getElementById("score").innerText = "Score: " + score;
      document.getElementById("lives").innerText = "Lives: " + lives;
      document.getElementById("timer").innerText = "Time: " + timeLeft + "s";
    }

    // ---- Drawing / game visuals ----
    function drawRoad() {
      ctx.fillStyle = "#222"; ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = "#fff"; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(5, 0); ctx.lineTo(5, canvas.height); ctx.moveTo(canvas.width - 5, 0); ctx.lineTo(canvas.width - 5, canvas.height); ctx.stroke();
      ctx.strokeStyle = "#bbb"; ctx.lineWidth = 2; ctx.setLineDash([10,10]);
      const laneWidth = (canvas.width - 10) / 3;
      for (let i=1;i<3;i++){ const x = 5 + i * laneWidth; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
      ctx.setLineDash([]);
    }
    function drawPlayer() { ctx.drawImage(carImage, lanes[player.lane], player.y, player.width, player.height); }
    function drawItems() {
      items.forEach(item => {
        if (item.type === "icon") {
          ctx.drawImage(iconImages[item.iconType], item.x + 5, item.y + 5, 50, 50);
        } else {
          ctx.font = "bold 12px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
          ctx.fillStyle = "#d38bf7";
          const lines = item.word.split("\n");
          const boxX = item.x + 5, boxY = item.y + 5, boxW = 64, boxH = 64;
          ctx.fillRect(boxX, boxY, boxW, boxH);
          ctx.fillStyle = "#000";
          lines.forEach((line, i) => {
            ctx.fillText(line, boxX + boxW / 2, boxY + boxH / 2 - (lines.length * 14) / 2 + i * 14 + 7);
          });
        }
      });
    }

    // ---- Movement / collisions ----
    function moveItems() {
      items.forEach(item => {
        item.y += speed;
        if (magnetActive && item.type === "point") {
          const targetX = lanes[player.lane];
          item.x += (targetX - item.x) * 0.1;
          item.y += (player.y - item.y) * 0.05;
        }
      });
    }

    function checkCollisions() {
      for (let i = items.length - 1; i >= 0; i--) {
        const item = items[i];
        const inLane = Math.abs(item.x - lanes[player.lane]) < 10;
        const hit = item.y < player.y + player.height && item.y + 60 > player.y;
        if (inLane && hit) {
          if (item.type === "word") {
            lives--;
            document.getElementById("blockSound").play();
            if (lives <= 0) return endGame();
          } else if (item.type === "point") {
            score += 5;
            document.getElementById("asdSound").play();
          } else if (item.type === "icon") {
            document.getElementById("asdSound").play();
            if (item.iconType === "group") lives++;
            if (item.iconType === "safety") {
              magnetActive = true; magnetTimer = 300;
            }
            if (item.iconType === "sustainability") {
              timeLeft += 5; // still works while playSecondsElapsed unaffected
            }
          }
          items.splice(i, 1);
        }
      }
    }

    // ---- Spawning items (safe to call continuously; spawnItems ignores when quizActive) ----
    function spawnItems() {
      if (!gameRunning || quizActive) return; // do not spawn while paused for quiz
      const lane = Math.floor(Math.random() * 3);
      const laneX = lanes[lane];
      const lastItem = [...items].reverse().find(i => i.x === laneX);
      if (lastItem && lastItem.y < 130) return;
      const rand = Math.random();
      const type = rand < 0.35 ? "word" : rand < 0.75 ? "point" : "icon";
      if (type === "icon") {
        const icon = icons[Math.floor(Math.random() * icons.length)].type;
        items.push({ type, x: laneX, y: -70, iconType: icon });
      } else {
        const word = type === "point" ? pointWords[Math.floor(Math.random() * pointWords.length)] : wordBlocks[Math.floor(Math.random() * wordBlocks.length)];
        items.push({ type, x: laneX, y: -70, word });
      }
    }

    // ---- Main game loop (animation) ----
    function gameLoop() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawRoad();
      drawPlayer();
      drawItems();
      // only update movement & collisions if not quizActive and gameRunning
      if (gameRunning && !quizActive) {
        moveItems();
        checkCollisions();
        if (magnetActive) {
          magnetTimer--;
          if (magnetTimer <= 0) magnetActive = false;
        }
      }
      updateInfo();
      if (gameRunning) requestAnimationFrame(gameLoop);
    }

    // ---- Game start / reset / end ----
    function resetGameState() {
      score = 0; lives = 3; timeLeft = 60; speed = 2.2;
      items.length = 0; magnetActive = false; magnetTimer = 0;
      playSecondsElapsed = 0; nextQuizAt = 15;
      updateInfo();
    }

    function startGame() {
      document.getElementById("bgMusic").play().catch(()=>{});
      resetGameState();
      gameRunning = true;
      quizActive = false;
      // clear previous intervals if any
      if (spawnInterval) clearInterval(spawnInterval);
      if (playTickInterval) clearInterval(playTickInterval);

      spawnInterval = setInterval(spawnItems, 200); // spawns only when !quizActive
      // playTickInterval ticks every second but only counts when not quizActive
      playTickInterval = setInterval(() => {
        if (!gameRunning) return;
        if (!quizActive) {
          // this counts active gameplay seconds
          playSecondsElapsed++;
          // trigger quiz when we've reached or passed the scheduled second
          if (playSecondsElapsed >= nextQuizAt) {
            showRandomQuiz();
            nextQuizAt += 15;
            // DO NOT decrement timeLeft here (quiz pauses countdown)
          }
          // only decrement the main countdown while not in quiz
          timeLeft--;
          if (timeLeft <= 0) {
            timeLeft = 0;
            clearInterval(playTickInterval);
            clearInterval(spawnInterval);
            endGame();
            return;
          }
        }
        updateInfo();
      }, 1000);

      requestAnimationFrame(gameLoop);
    }

    function endGame() {
      // Stop background play
      try { const bgMusic = document.getElementById("bgMusic"); bgMusic.pause(); bgMusic.currentTime = 0; } catch(e){ }
      gameRunning = false;
      quizActive = false;
      if (spawnInterval) clearInterval(spawnInterval);
      if (playTickInterval) clearInterval(playTickInterval);
      document.getElementById("finalScore").innerText = "Score: " + score;
      document.getElementById("popup").style.display = "flex";
      // POST score if submitted
      if (userSubmitted) {
        const payload = { employeeNumber: userData.employeeNumber, department: userData.department, score: score };
        fetch("https://script.google.com/macros/s/AKfycbzg2_8dHtTYdfv9_AU4XvNX4tS538STAeTSrNUkXEOHPjeNNon0F9dYALs-SwX7kuyA/exec", {
          method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
        }).catch(()=>{});
      }
    }

    function closePopup() {
      document.getElementById("popup").style.display = "none";
      resetGameState();
      document.getElementById("controls").style.display = "block";
      document.getElementById("infoBar").style.display = "flex";
      document.getElementById("gameCanvas").style.display = "block";
    }

    function closeGame() {
      gameRunning = false;
      if (spawnInterval) clearInterval(spawnInterval);
      if (playTickInterval) clearInterval(playTickInterval);
      try { document.getElementById("bgMusic").pause(); } catch(e){}
      // Try to close window - might be blocked by browser
      try { window.close(); } catch(e) { /* ignore */ }
    }

    // ---- Quiz system ----
    const quizModal = document.getElementById("quizModal");
    const quizQuestionElem = document.getElementById("quizQuestion");
    const quizChoicesElem = document.getElementById("quizChoices");

    function showRandomQuiz() {
      if (!gameRunning) return;
      // Pause game logic but keep game state in memory
      quizActive = true;
      // Pause music
      try { document.getElementById("bgMusic").pause(); } catch(e){}
      // pick a random question
      const q = getNextQuestion();
      // render modal
      quizQuestionElem.innerText = q.q;
      quizChoicesElem.innerHTML = "";
      q.choices.forEach((ch, idx) => {
        const btn = document.createElement("button");
        btn.className = "choiceBtn";
        btn.innerText = String.fromCharCode(65 + idx) + ". " + ch;
        btn.onclick = () => handleQuizAnswer(q, idx);
        quizChoicesElem.appendChild(btn);
      });
      quizModal.style.display = "flex";
    }

    function handleQuizAnswer(q, chosenIdx) {
      // correct?
      const correct = chosenIdx === q.answerIndex;
      // hide modal
      quizModal.style.display = "none";
      if (!correct) {
        // wrong answer => game over immediately
        endGame();
        return;
      } else {
        // correct answer => resume game
        quizActive = false;
        try { document.getElementById("bgMusic").play().catch(()=>{}); } catch(e){}
        // continue gameLoop (if gameRunning true, gameLoop keeps animating)
      }
    }

    // ---- Input / controls ----
    document.getElementById("startBtn").addEventListener("click", startGame);
    document.addEventListener("keydown", e => {
      if (!gameRunning || quizActive) return;
      if (e.key === "ArrowLeft" && player.lane > 0) player.lane--;
      if (e.key === "ArrowRight" && player.lane < 2) player.lane++;
    });

    canvas.addEventListener("touchstart", e => {
      if (!gameRunning || quizActive) return;
      const touchX = e.touches[0].clientX;
      if (touchX < window.innerWidth / 2 && player.lane > 0) player.lane--;
      else if (touchX > window.innerWidth / 2 && player.lane < 2) player.lane++;
    });

    // ---- User form submission ----
    function submitUserInfo() {
      const empNo = document.getElementById("empNo").value.trim();
      const dept = document.getElementById("dept").value.trim();
      if (!empNo || !dept) { alert("Please fill in all fields before playing the game."); return; }
      userData.employeeNumber = empNo; userData.department = dept; userSubmitted = true;
      document.getElementById("userForm").style.display = "none";
      document.getElementById("controls").style.display = "block";
      document.getElementById("infoBar").style.display = "flex";
      document.getElementById("gameCanvas").style.display = "block";
      document.getElementById("score").innerText = "Score: " + score;
      document.getElementById("lives").innerText = "Lives: " + lives;
      document.getElementById("timer").innerText = "Time: " + timeLeft + "s";
    }

    // ---- initialization UI ----
    document.getElementById("infoBar").style.display = "none";
    document.getElementById("gameCanvas").style.display = "none";
    updateInfo();
  </script>
</body>
</html>
