<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Responsive Car Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; }
    canvas { border: 2px solid #333; background: #eee; margin-top: 20px; }
    #info, #userForm, #popup { margin-top: 20px; }
    #popup { display: none; flex-direction: column; align-items: center; background: rgba(0, 0, 0, 0.7); color: white; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; justify-content: center; }
    #popup button { margin-top: 20px; padding: 10px 20px; }
  </style>
</head>
<body>
  <div id="userForm">
    <input type="text" id="name" placeholder="Name" />
    <input type="text" id="employeeNumber" placeholder="Employee Number" />
    <input type="text" id="department" placeholder="Department" />
    <button onclick="submitUserInfo()">Play Game</button>
  </div>
  <div id="info">
    <p id="scoreDisplay">Score: 0</p>
    <p id="timeDisplay">Time Left: 60</p>
  </div>
  <canvas id="gameCanvas" width="400" height="600"></canvas>
  <div id="popup">
    <h2>Game Over</h2>
    <p id="finalScore"></p>
    <button onclick="closePopupAndRestart()">Play Again</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCJv6vYn1Ca6CVlnT8uOFoYwah50kOTkCw",
      authDomain: "car-game-62caf.firebaseapp.com",
      projectId: "car-game-62caf",
      storageBucket: "car-game-62caf.appspot.com",
      messagingSenderId: "355200563779",
      appId: "1:355200563779:web:781097cc0dd705b443f2f6",
      measurementId: "G-2GYMD81CDN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    let score = 0, timeLeft = 60, gameRunning = false, spawnInterval;
    let player = { x: 180, y: 500, width: 40, height: 80 };
    let items = [];
    let userData = {};

    function updateInfo() {
      document.getElementById("scoreDisplay").innerText = `Score: ${score}`;
      document.getElementById("timeDisplay").innerText = `Time Left: ${timeLeft}`;
    }

    function resetGameState() {
      player.x = 180;
      score = 0;
      timeLeft = 60;
      items = [];
      updateInfo();
    }

    function drawRoad() {
      ctx.fillStyle = "#888";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawPlayer() {
      ctx.fillStyle = "blue";
      ctx.fillRect(player.x, player.y, player.width, player.height);
    }

    function drawItems() {
      ctx.fillStyle = "red";
      items.forEach(item => ctx.fillRect(item.x, item.y, item.size, item.size));
    }

    function moveItems() {
      items.forEach(item => item.y += 5);
      items = items.filter(item => item.y < canvas.height);
    }

    function checkCollisions() {
      items.forEach((item, index) => {
        if (
          player.x < item.x + item.size &&
          player.x + player.width > item.x &&
          player.y < item.y + item.size &&
          player.y + player.height > item.y
        ) {
          items.splice(index, 1);
          score++;
          updateInfo();
        }
      });
    }

    function spawnItems() {
      const size = 20;
      const x = Math.random() * (canvas.width - size);
      items.push({ x, y: 0, size });
    }

    function gameLoop() {
      if (!gameRunning) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawRoad();
      drawPlayer();
      drawItems();
      moveItems();
      checkCollisions();
      requestAnimationFrame(gameLoop);
    }

    function startGame() {
      resetGameState();
      gameRunning = true;
      gameLoop();
      if (spawnInterval) clearInterval(spawnInterval);
      spawnInterval = setInterval(spawnItems, 200);
      const timerInterval = setInterval(() => {
        if (!gameRunning) return clearInterval(timerInterval);
        timeLeft--;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          clearInterval(spawnInterval);
          endGame();
        }
        updateInfo();
      }, 1000);
    }

    async function endGame() {
      gameRunning = false;
      clearInterval(spawnInterval);
      document.getElementById("finalScore").innerText = `Score: ${score}`;
      document.getElementById("popup").style.display = "flex";
      await addDoc(collection(db, "CarGameScore"), {
        Name: userData.name,
        EmployeeNumber: userData.employeeNumber,
        Department: userData.department,
        Score: score
      });
    }

    function closePopupAndRestart() {
      document.getElementById("popup").style.display = "none";
      startGame();
    }

    window.submitUserInfo = function () {
      const name = document.getElementById("name").value.trim();
      const employeeNumber = document.getElementById("employeeNumber").value.trim();
      const department = document.getElementById("department").value.trim();

      if (!name || !employeeNumber || !department) {
        alert("Please fill in all fields.");
        return;
      }

      userData = { name, employeeNumber, department };
      document.getElementById("userForm").style.display = "none";
      startGame();
    };

    document.addEventListener("keydown", e => {
      if (e.key === "ArrowLeft" && player.x > 0) player.x -= 10;
      if (e.key === "ArrowRight" && player.x + player.width < canvas.width) player.x += 10;
    });
  </script>
</body>
</html>
